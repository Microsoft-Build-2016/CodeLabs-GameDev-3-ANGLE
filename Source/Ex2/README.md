<a name="HOLTop" />
# Integrating your Game Code with ANGLE #

---


<a name="Exercise2" />
### Exercise 2: Integrating your Game Code with ANGLE ###

In this exercise, you will modify the ANGLE project you created in Exercise 1 to include the code for a simple game called Breakout. In order to save you a lot of steps, we have already added the game code to the project. For this module we adapted the Breakout game tutorial from <http://learnopengl.com/#!In-Practice/2D-Game/Breakout>. We will now modify the code generated by the ANGLE template to integrate the Breakout game code.

In this exercise you will complete the following steps:

1. Modify the XAML page created by the ANGLE template to prepare the app for our game.
1. Connect the ANGLE framework to our game's update/render loop.

#### Task 1 - Modify the XAML ####
The ANGLE XAML App for OpenGL ES template generates a Windows 10 XAML app that is correctly set up to use OpenGL ES 2.0 in your app. Your game code will need to be integrated with the OpenGLESPage.xaml page. This page handles the initialization of the OpenGL context and creates a rendering loop in which you will update and render your game. There are a few minor modifications we need to make to the OpenGLESPage XAML code to prepare the page for our game.

1. Open **Breakout.sln** in the **CodeLabs/Workshops/Games/Module3-ANGLE/Source/Ex2/Begin** folder.

1. Select **Debug x64** from the Project Configuration and Platform dropdowns.

	![Configuring the build target](../../Images/ex2-debug-x64.PNG?raw=true "Configuring the build target")

	_Configuring the build target_

1. Press **F5** to build and run the project. The app should look like this:

	![ANGLE app](../../Images/ex1-sample-angle-app.PNG?raw=true "ANGLE app")

	_ANGLE app_

1. Close the app to stop debugging. We need to first make some simple modifications to the app. First of all, let's remove the text _OpenGL ES and XAML_. Open the file **OpenGLESPage.xaml** and remove the TextBlock at line 11.

 ````XML
 <TextBlock Text="OpenGL ES and XAML" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="30" />
 ````

 Your XAML file should now look like this:

 ````XML
 <Page
    x:Class="Breakout.OpenGLESPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Breakout"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <SwapChainPanel x:Name="swapChainPanel">
    </SwapChainPanel>
 </Page>
 ````
While you are editing this file, you should also set the page background to black by adding the line `Background="Black"`

 ````XML
 <Page
    x:Class="Breakout.OpenGLESPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Breakout"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Background="Black"
    mc:Ignorable="d">

    <SwapChainPanel x:Name="swapChainPanel">
    </SwapChainPanel>
 </Page>
````

1. Press **F5** to build and run the project. Your app should now look like this:

	![ANGLE app](../../Images/ex2-rotating-cube-black.PNG?raw=true "ANGLE app")

	_ANGLE app_

#### Task 2 - Connect the ANGLE Framework to the Game Loop ####

In this task, you'll connect the ANGLE Framework to the Game Loop.

 > **Note:** The following section uses code snippets to insert code into your project. If you don't want to use code snippets, or code snippets are not setup, you can copy the code for [SimpleRenderer.h](./End/Breakout/SimpleRenderer.h) and  [SimpleRenderer.cpp](./End/Breakout/SimpleRenderer.cpp).

1. Open the file **Breakout/SimpleRenderer.h**. Delete all of the code in the file.

1. Copy the code from  **[SimpleRenderer.h](./End/Breakout/SimpleRenderer.h)** and paste it into **SimpleRenderer.h**.

1. Open the file **Breakout/SimpleRenderer.cpp**. Delete all of the code in the file.

1. Copy the code from  **[SimpleRenderer.cpp](./End/Breakout/SimpleRenderer.cpp)** and paste it into **SimpleRenderer.cpp**.

1. Save your work. Press **F5** to build and run your app. You app should now look like this:

	![Breakout App](../../Images/ex2-breakout-app.png?raw=true "Breakout App")

	_Breakout App_

#### Discussion ####

In the original ANGLE template, all of the drawing code was contained in a the file SimpleRenderer.cpp. The Breakout game has all of its game code in Source/Game.cpp. We modified SimpleRenderer.cpp to work as an adapter from the ANGLE app framework to our Breakout game. Open the file SimpleRenderer.cpp and scroll to the Draw() function at line 25. Here you will see the typical update/render pattern for you to draw a single frame of your game.

````C++
void SimpleRenderer::Draw()
{
    if (mGame != nullptr)
    {
        float deltaTime = static_cast<float>(mTimer->getDeltaTime());
        mGame->ProcessInput(deltaTime);
        mGame->Update(deltaTime);
        mGame->Render();
    }

    mDrawCount += 1;
}
````

The SimpleRenderer::Draw() method will be called at 60 FPS by the rendering loop created in OpenGLESPage::StartRenderLoop() in OpenGLESPage.xaml.cpp around line 105

````C++
void OpenGLESPage::StartRenderLoop()
{
    ...

    // Create a task for rendering that will be run on a background thread.
    auto workItemHandler = ref new Windows::System::Threading::WorkItemHandler([this](Windows::Foundation::IAsyncAction ^ action)
    {
        critical_section::scoped_lock lock(mRenderSurfaceCriticalSection);

        mOpenGLES->MakeCurrent(mRenderSurface);

        if (mRenderer.get() == nullptr)
        {
            mRenderer = std::make_shared<SimpleRenderer>();
        }

        while (action->Status == Windows::Foundation::AsyncStatus::Started)
        {
            EGLint panelWidth = 0;
            EGLint panelHeight = 0;
            mOpenGLES->GetSurfaceDimensions(mRenderSurface, &panelWidth, &panelHeight);

            // Logic to update the scene could go here
            mRenderer->UpdateWindowSize(panelWidth, panelHeight);
            mRenderer->Draw();
            ...
        }
    });
    ....
}
````

Please make note of another small change we made to OpenGLESPage::StartRenderLoop() around line 120. The original ANGLE template recreates and destroys the SimpleRenderer object every time the visibility of the app changes. In our code we will create our game code once to prevent having to reload all our game resources and shaders

````C++
void OpenGLESPage::StartRenderLoop()
{
    ...
        if (mRenderer.get() == nullptr)
        {
            mRenderer = std::make_shared<SimpleRenderer>();
        }
    ....
}
````

We also updated the code in [App.xaml.h](./End/Breakout/App.xaml.h)  amd App.xaml.cpp [App.xaml.cpp](./End/Breakout/App.xaml.cpp). This will allow your app to pass [Windows App Certification Kit](https://msdn.microsoft.com/en-us/windows/uwp/debug-test-perf/windows-app-certification-kit) testing (WACK).
It is a good idea to run WACK tests often to make sure your app can be certified for release in the Windows Store. We will discuss WACK testing in a future tutorial.

If you press F5 to run the game you will notice the following issues:

1. Resizing the window does not resize the game.
2. The game does not respond to mouse/touch/keyboard events.

#### Next ####

We will now add support for resizing the window.

- Continue on to [Exercise 3: Resizing the window](../../Source/Ex3/README.md)
- Return to [Start](../../README.md)
